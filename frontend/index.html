<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Sphere | Dialogue</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d0d12;
            --card-bg: rgba(255, 255, 255, 0.03);
            --accent-color: #6366f1;
            --user-msg-bg: #6366f1;
            --ai-msg-bg: rgba(255, 255, 255, 0.08);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            height: -webkit-fill-available;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 0.6rem;
            background: rgba(13, 13, 18, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
            z-index: 10;
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #fff 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Chat Area */
        /* Memory Bar */
        #memory-bar {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            padding: 0.7rem 1.2rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            z-index: 5;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.5rem;
            max-height: 48px;
            /* é»˜è®¤ç´§å‡‘é«˜åº¦ */
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            cursor: pointer;
        }

        #memory-bar.expanded {
            max-height: 48vh;
            background: rgba(13, 13, 18, 0.98);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overscroll-behavior: contain;
        }

        #memory-content {
            flex: 1;
            line-height: 1.5;
            word-break: break-word;
            opacity: 0.8;
        }

        #memory-bar.expanded #memory-content {
            opacity: 1;
        }

        .vault-btn {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            cursor: pointer;
            white-space: nowrap;
        }

        /* äº‹å®çœ‹æ¿ä¸å¾…åŠçœ‹æ¿æ¨¡æ€æ¡† */
        #fact-vault,
        #todo-vault {
            display: none;
            position: fixed;
            top: 10%;
            left: 5%;
            width: 90%;
            height: 80%;
            background: rgba(13, 13, 18, 0.98);
            backdrop-filter: blur(25px);
            z-index: 2000;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overscroll-behavior: contain;
            color: var(--text-primary);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.03);
            margin-bottom: 0.8rem;
            padding: 1rem;
            border-radius: 16px;
            transition: opacity 0.3s;
        }

        .todo-item.completed {
            opacity: 0.5;
        }

        .todo-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .todo-text {
            flex: 1;
            font-size: 0.95rem;
        }

        .fact-item {
            background: rgba(255, 255, 255, 0.03);
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 16px;
            border-left: 3px solid var(--accent-color);
        }

        .fact-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }

        .fact-summary {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent-color);
        }

        .fact-origin {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }

        #chat-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 85%;
            padding: 1rem 1.2rem;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            /* animation: slideIn 0.3s ease-out; ä¸´æ—¶ç¦ç”¨ä»¥ä¼˜åŒ–ç§»åŠ¨ç«¯æ»‘åŠ¨ */
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-self: flex-end;
            background: var(--user-msg-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            align-self: flex-start;
            background: var(--ai-msg-bg);
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 4px;
        }

        .ai-message::before {
            content: 'Sphere';
            position: absolute;
            top: -1.2rem;
            left: 0.2rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Input Area */
        .input-area {
            padding: 1.2rem;
            background: rgba(13, 13, 18, 0.9);
            border-top: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .input-row {
            display: flex;
            gap: 0.8rem;
        }

        textarea {
            flex: 1;
            height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 0.8rem 1.2rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            border-color: var(--accent-color);
        }

        .btn-circle {
            width: 50px;
            height: 50px;
            background: var(--accent-color);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .capture-btn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Loading */
        .typing {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
            display: none;
        }

        /* Scrollbar */
        #chat-container::-webkit-scrollbar {
            width: 4px;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <header>
        <h1>Project Sphere</h1>
    </header>

    <div id="memory-bar" onclick="toggleMemoryBar(event)">
        <span><strong>Context:</strong> <span id="memory-content">æ­£åœ¨å”¤é†’è®°å¿†...</span></span>
        <div style="display: flex; gap: 5px;">
            <button class="vault-btn" onclick="toggleTodoVault(); event.stopPropagation();"
                style="background: rgba(16, 185, 129, 0.2); border-color: #10b981;">å¾…åŠ</button>
            <button class="vault-btn" onclick="toggleVault(); event.stopPropagation();">äº‹å®å®åº“</button>
        </div>
    </div>

    <!-- å¾…åŠä¸­å¿ƒ -->
    <div id="todo-vault">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-family: 'Outfit';">AI å¾…åŠä¸­å¿ƒ</h2>
            <button class="vault-btn" onclick="toggleTodoVault()">å…³é—­</button>
        </div>
        <div id="todo-list">æ­£åœ¨åŒæ­¥ä»»åŠ¡...</div>
    </div>

    <!-- äº‹å®çœ‹æ¿ -->
    <div id="fact-vault">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-family:'Outfit', sans-serif;">L3 äº‹å®å½’æ¡£</h2>
            <button class="vault-btn" onclick="toggleVault()">å…³é—­</button>
        </div>
        <div id="vault-list"></div>
    </div>

    <div id="chat-container">
        <div class="message ai-message">
            æ¬¢è¿æ¥åˆ° Sphereã€‚æˆ‘æ˜¯ä½ çš„ç¬¬äºŒå¤§è„‘ã€‚ä½ å¯ä»¥ç›´æ¥å‘¼å”¤æˆ‘ï¼Œæˆ–è€…ç‚¹å‡»ä¸‹æ–¹â€œCaptureâ€å°†å†…å®¹ç‰©ç†åŒæ­¥è‡³ Obsidianã€‚
        </div>
    </div>

    <div class="input-area">
        <div class="action-row">
            <span id="typing-indicator" class="typing">Sphere æ­£åœ¨æ€è€ƒ...</span>
            <button class="capture-btn" onclick="triggerCapture()">Capture to Cloud</button>
        </div>
        <div class="input-row">
            <textarea id="msg-input" placeholder="è¾“å…¥çµæ„Ÿæˆ–é—®é¢˜..."></textarea>
            <button class="btn-circle" onclick="sendMessage()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="color: white;">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const msgInput = document.getElementById('msg-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const memoryContent = document.getElementById('memory-content');
        let history = [];
        let lastSentContent = ''; // ç¼“å­˜æœ€åä¸€æ¬¡å‘é€çš„å†…å®¹
        let currentSummary = '';  // å­˜å‚¨ L2 åŠ¨æ€æ‘˜è¦

        // --- ç®€å•é‰´æƒä¿æŠ¤ ---
        function checkAuth() {
            if (localStorage.getItem('sphere_auth') === 'verified') return true;
            const pass = prompt("Project Sphere ç‹¬ç«‹è®¿é—®æš—å·ï¼š");
            if (pass === '2026') {
                localStorage.setItem('sphere_auth', 'verified');
                return true;
            }
            alert("æš—å·é”™è¯¯ï¼Œæ‹’ç»è®¿é—®ã€‚");
            document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:20%'>403 Forbidden</h1>";
            return false;
        }

        // --- åˆå§‹åŒ–ï¼šä»æœ¬åœ°å­˜å‚¨/äº‘ç«¯æ¢å¤è®°å¿† ---
        window.onload = async () => {
            if (!checkAuth()) return;

            // ä¼˜å…ˆå°è¯•ä»äº‘ç«¯æ¢å¤å†å²ï¼Œå®ç°å¤šç«¯åŒæ­¥
            try {
                const response = await fetch('/session/load');
                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    history = data.history;
                    currentSummary = data.summary || '';
                    chatContainer.innerHTML = '';
                    history.forEach(item => {
                        addMessage(item.content, item.role === 'user' ? 'user' : 'ai', false);
                    });
                    memoryContent.innerText = currentSummary || 'æš‚æ— ä¸Šä¸‹æ–‡æ‘˜è¦';
                    return;
                }
            } catch (e) {
                console.error("Cloud load failed, falling back to local:", e);
            }

            const savedHistory = localStorage.getItem('sphere_history');
            const savedSummary = localStorage.getItem('sphere_summary');

            if (savedHistory) {
                history = JSON.parse(savedHistory);
                chatContainer.innerHTML = ''; // æ¸…é™¤é»˜è®¤æ¬¢è¿è¯ï¼Œæ¸²æŸ“å†å²
                history.forEach(item => {
                    addMessage(item.content, item.role === 'user' ? 'user' : 'ai', false);
                });
            }
            if (savedSummary) {
                currentSummary = savedSummary;
                memoryContent.innerText = currentSummary;
            } else {
                memoryContent.innerText = "æš‚æ— å†å²è®°å¿†ï¼Œå¼€å§‹å¯¹è¯ä»¥å»ºç«‹ä¸Šä¸‹æ–‡ã€‚";
            }
        };

        async function sendMessage() {
            const text = msgInput.value.trim();
            if (!text) return;

            lastSentContent = text; // æ›´æ–°ç¼“å­˜
            addMessage(text, 'user');
            msgInput.value = '';

            // åˆ›å»ºä¸€ä¸ªå ä½çš„ AI æ¶ˆæ¯å®¹å™¨
            const aiMsgDiv = addMessage('', 'ai');
            typingIndicator.style.display = 'block';

            try {
                const response = await fetch(`/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        history: history,
                        summary: currentSummary
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    fullContent += chunk;

                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å…ƒæ•°æ®æ ‡è®°
                    if (fullContent.includes('[METADATA]')) {
                        const parts = fullContent.split('[METADATA]');
                        // å±•ç¤ºæ­£æ–‡éƒ¨åˆ† (å±è”½å…ƒæ•°æ®)
                        aiMsgDiv.innerText = parts[0];

                        // åªæœ‰å½“æµç»“æŸæˆ–è€… JSON çœ‹èµ·æ¥å®Œæ•´æ—¶å†å°è¯•è§£æ
                        // è¿™é‡Œæˆ‘ä»¬é‡‡å–ä¿å®ˆç­–ç•¥ï¼šåœ¨å¾ªç¯ç»“æŸåå†ç»Ÿä¸€è§£ææœ€ç»ˆå…ƒæ•°æ®
                    } else {
                        aiMsgDiv.innerText = fullContent;
                    }

                    // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰å½“ç”¨æˆ·æœ¬æ¥å°±åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
                    const isAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 100;
                    if (isAtBottom) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                }

                // æµç»“æŸåçš„æœ€ç»ˆå¤„ç†ï¼šè§£æå®Œæ•´çš„å…ƒæ•°æ®
                if (fullContent.includes('[METADATA]')) {
                    const parts = fullContent.split('[METADATA]');
                    aiMsgDiv.innerText = parts[0]; // ç¡®ä¿æœ€ç»ˆæ˜¾ç¤ºä¸å«æ ‡è®°ä½
                    try {
                        const metadata = JSON.parse(parts[1]);
                        history = metadata.history || [];
                        currentSummary = metadata.summary || '';

                        let displayContent = "";
                        if (metadata.pinned_facts && metadata.pinned_facts.length > 0) {
                            displayContent += "ğŸ“Œ [é”å®šäº‹å®]:\n" + metadata.pinned_facts.map(f => `â€¢ ${f}`).join('\n') + "\n\n";
                        }
                        displayContent += "ğŸ“ [åŠ¨æ€æ‘˜è¦]:\n" + (currentSummary || "å°šæ— åŠ¨æ€æ‘˜è¦");

                        memoryContent.innerText = displayContent;

                        if (metadata.todos) {
                            todos = metadata.todos;
                            renderTodos();
                        }

                        // åŒæ­¥è‡³æœ¬åœ°ä¸äº‘ç«¯
                        localStorage.setItem('sphere_history', JSON.stringify(history));
                        localStorage.setItem('sphere_summary', currentSummary);
                        syncToCloud();
                    } catch (e) {
                        console.error("Final Metadata Parse Error", e);
                    }
                }
            } catch (err) {
                aiMsgDiv.innerText = 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚';
            } finally {
                typingIndicator.style.display = 'none';
            }
        }

        async function syncToCloud() {
            try {
                await fetch('/session/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history, summary: currentSummary })
                });
            } catch (e) {
                console.warn("Cloud sync failed:", e);
            }
        }

        async function triggerCapture() {
            // ä¼˜å…ˆæ•è·è¾“å…¥æ¡†å†…å®¹ï¼Œè‹¥ä¸ºç©ºåˆ™å°è¯•æ•è·æœ€åä¸€æ¡å‘é€çš„æ¶ˆæ¯
            let text = msgInput.value.trim();
            if (!text) {
                text = lastSentContent;
            }

            if (!text) {
                alert('è¯·å…ˆè¾“å…¥éœ€è¦æ•è·çš„å†…å®¹ï¼Œæˆ–å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚');
                return;
            }

            typingIndicator.innerText = 'æ­£åœ¨ç‰©ç†åŒæ­¥...';
            typingIndicator.style.display = 'block';

            try {
                const response = await fetch(`/collect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: text, source: 'mobile_chat' })
                });
                const data = await response.json();
                addMessage(`âœ… çµæ„Ÿå·²åŒæ­¥è‡³äº‘ç«¯äº‹å®äº‘ (L3)\næ‘˜è¦ï¼š${data.summary}`, 'ai');
                if (msgInput.value.trim() === text) {
                    msgInput.value = '';
                }
            } catch (err) {
                alert('æ•è·å¤±è´¥');
            } finally {
                typingIndicator.style.display = 'none';
                typingIndicator.innerText = 'Sphere æ­£åœ¨æ€è€ƒ...';
            }
        }

        function addMessage(text, role, smooth = true) {
            const div = document.createElement('div');
            div.className = `message ${role}-message`;
            div.innerText = text;
            if (!smooth) div.style.animation = 'none'; // æ¢å¤å†å²æ—¶ç¦ç”¨åŠ¨ç”»ï¼Œé¿å…é—ªçƒ
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }

        async function toggleVault() {
            const vault = document.getElementById('fact-vault');
            if (vault.style.display === 'block') {
                vault.style.display = 'none';
                return;
            }

            vault.style.display = 'block';
            const list = document.getElementById('vault-list');
            list.innerHTML = 'æ­£åœ¨è¯»å–äº‹å®äº‘...';

            try {
                const response = await fetch('/facts');
                const facts = await response.json();

                if (facts.length === 0) {
                    list.innerHTML = '<div style="text-align:center; margin-top:50px; opacity:0.5;">å®åº“å°šç©ºï¼Œå®Œæˆ Capture ä»¥å½’æ¡£äº‹å®ã€‚</div>';
                    return;
                }

                list.innerHTML = facts.reverse().map(f => `
                    <div class="fact-item">
                        <div class="fact-time">${new Date(f.timestamp).toLocaleString()}</div>
                        <div class="fact-summary">${f.summary}</div>
                        <div class="fact-origin">"${f.content.substring(0, 100)}${f.content.length > 100 ? '...' : ''}"</div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = 'è¯»å–å¤±è´¥ï¼š' + e.message;
            }
        }

        let todos = [];

        async function toggleTodoVault() {
            const vault = document.getElementById('todo-vault');
            if (vault.style.display === 'block') {
                vault.style.display = 'none';
                return;
            }
            vault.style.display = 'block';
            await loadTodos();
        }

        async function loadTodos() {
            try {
                const response = await fetch('/todos');
                todos = await response.json();
                renderTodos();
            } catch (e) {
                document.getElementById('todo-list').innerText = 'ä»»åŠ¡åŠ è½½å¤±è´¥';
            }
        }

        function renderTodos() {
            const list = document.getElementById('todo-list');
            if (!todos || todos.length === 0) {
                list.innerHTML = '<div style="text-align:center; margin-top:50px; opacity:0.5;">æš‚æ— å¾…åŠäº‹é¡¹ã€‚</div>';
                return;
            }
            list.innerHTML = todos.map(t => `
                <div class="todo-item ${t.completed ? 'completed' : ''}">
                    <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodoStatus('${t.id}')">
                    <span class="todo-text">${t.task}</span>
                </div>
            `).join('');
        }

        async function toggleTodoStatus(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                renderTodos();
                // åŒæ­¥è‡³æœåŠ¡å™¨
                try {
                    await fetch('/todos/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(todos)
                    });
                } catch (e) {
                    console.error("Todo Sync Failed", e);
                }
            }
        }

        function toggleMemoryBar(e) {
            // é˜²æ­¢ç‚¹å‡»æŒ‰é’®è§¦å‘æŠ˜å 
            if (e.target.closest('.vault-btn')) return;
            const bar = document.getElementById('memory-bar');
            bar.classList.toggle('expanded');
        }

        msgInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>

</html>