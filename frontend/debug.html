<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Sphere - Debug Panel</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1a1a1a;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            background: #2d2d2d;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .section h2 {
            color: #81C784;
            margin-top: 0;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #45a049;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #2e7d32; }
        .status.error { background: #c62828; }
        .status.info { background: #1976d2; }
        .status.warning { background: #f57c00; }
        
        .archive-section {
            border-left: 4px solid #ff9800 !important;
        }
        
        .archive-section h2 {
            color: #ffb74d !important;
        }
        
        .btn.archive {
            background: #ff9800;
        }
        
        .btn.archive:hover {
            background: #f57c00;
        }
        
        .btn.danger {
            background: #d32f2f;
        }
        
        .btn.danger:hover {
            background: #b71c1c;
        }
        
        .memory-file {
            background: #333;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #2196F3;
        }
        
        .memory-file h3 {
            color: #64B5F6;
            margin: 0 0 10px 0;
            cursor: pointer;
        }
        
        .memory-file h3:hover {
            color: #90CAF9;
        }
        
        .memory-content {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .memory-content.expanded {
            display: block;
        }
        
        .memory-meta {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Project Sphere Debug Panel</h1>
        
        <div class="section">
            <h2>ç³»ç»ŸçŠ¶æ€</h2>
            <div id="system-status">
                <div class="status info">æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>
            </div>
            <button class="btn" onclick="checkSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="section">
            <h2>æœ€è¿‘çš„Promptæ—¥å¿—</h2>
            <button class="btn" onclick="loadPromptLog()">åŠ è½½Promptæ—¥å¿—</button>
            <pre id="prompt-log">ç‚¹å‡»"åŠ è½½Promptæ—¥å¿—"æŸ¥çœ‹æœ€è¿‘çš„å¯¹è¯prompt...</pre>
        </div>

        <div class="section">
            <h2>è®°å¿†ç³»ç»Ÿæµ‹è¯•</h2>
            <button class="btn" onclick="testMemorySystem()">æµ‹è¯•è®°å¿†ç³»ç»Ÿ</button>
            <div id="memory-test-result"></div>
        </div>

        <div class="section">
            <h2>APIæµ‹è¯•</h2>
            <button class="btn" onclick="testChatAPI()">æµ‹è¯•èŠå¤©API</button>
            <div id="api-test-result"></div>
        </div>

        <div class="section archive-section">
            <h2>æ¯æ—¥å½’æ¡£ç®¡ç†</h2>
            <button class="btn archive" onclick="triggerDailyArchive()">ğŸ—‚ï¸ æ‰‹åŠ¨è§¦å‘æ¯æ—¥å½’æ¡£</button>
            <button class="btn" onclick="loadCurrentSession()">ğŸ“Š åŠ è½½å½“å‰ä¼šè¯çŠ¶æ€</button>
            <div id="archive-result"></div>
            <div id="session-info"></div>
        </div>

        <div class="section">
            <h2>M3é•¿æœŸè®°å¿†æŸ¥çœ‹</h2>
            <button class="btn" onclick="loadMemoryList()">ğŸ“‹ åŠ è½½è®°å¿†æ–‡ä»¶åˆ—è¡¨</button>
            <button class="btn" onclick="loadAllMemories()">ğŸ“š æŸ¥çœ‹æ‰€æœ‰è®°å¿†å†…å®¹</button>
            <button class="btn danger" onclick="deleteMemoryFile()">ğŸ—‘ï¸ åˆ é™¤è®°å¿†æ–‡ä»¶</button>
            <div id="memory-list"></div>
            <div id="memory-viewer"></div>
        </div>
    </div>

    <script>
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '<div class="status info">æ£€æŸ¥ä¸­...</div>';
            
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div class="status success">âœ… ç³»ç»Ÿæ­£å¸¸è¿è¡Œ</div>
                        <div class="status info">é¡¹ç›®: ${data.project}</div>
                        <div class="status info">çŠ¶æ€: ${data.status}</div>
                    `;
                } else {
                    statusDiv.innerHTML = '<div class="status error">âŒ ç³»ç»Ÿå¼‚å¸¸</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadPromptLog() {
            const logDiv = document.getElementById('prompt-log');
            logDiv.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await fetch('/debug/prompt');
                const data = await response.json();
                logDiv.textContent = data.content || 'æš‚æ— æ—¥å¿—å†…å®¹';
            } catch (error) {
                logDiv.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }

        async function testMemorySystem() {
            const resultDiv = document.getElementById('memory-test-result');
            resultDiv.innerHTML = '<div class="status info">æµ‹è¯•ä¸­...</div>';
            
            try {
                // æµ‹è¯•è®°å¿†æ–‡ä»¶åˆ—è¡¨
                const listResponse = await fetch('/memory/list');
                const listData = await listResponse.json();
                
                if (listData.files && listData.files.length > 0) {
                    // æµ‹è¯•è¯»å–ç¬¬ä¸€ä¸ªæ–‡ä»¶
                    const testFile = listData.files[0];
                    const readResponse = await fetch('/memory/fetch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: testFile })
                    });
                    const readData = await readResponse.json();
                    
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… è®°å¿†ç³»ç»Ÿæ­£å¸¸</div>
                        <div class="status info">å¯ç”¨æ–‡ä»¶æ•°: ${listData.files.length}</div>
                        <div class="status info">æµ‹è¯•æ–‡ä»¶: ${testFile}</div>
                        <div class="status info">è¯»å–çŠ¶æ€: ${readData.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="status error">âŒ æœªæ‰¾åˆ°è®°å¿†æ–‡ä»¶</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testChatAPI() {
            const resultDiv = document.getElementById('api-test-result');
            resultDiv.innerHTML = '<div class="status info">æµ‹è¯•ä¸­...</div>';
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'æµ‹è¯•æ¶ˆæ¯',
                        history: [],
                        summary: '',
                        auto_save: false
                    })
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="status success">âœ… èŠå¤©APIå“åº”æ­£å¸¸</div>';
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ APIé”™è¯¯: ${response.status}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadCurrentSession() {
            const sessionDiv = document.getElementById('session-info');
            sessionDiv.innerHTML = '<div class="status info">åŠ è½½ä¼šè¯çŠ¶æ€ä¸­...</div>';
            
            try {
                const response = await fetch('/session/load');
                const data = await response.json();
                
                const historyCount = data.history ? data.history.length : 0;
                const summaryLength = data.summary ? data.summary.length : 0;
                
                sessionDiv.innerHTML = `
                    <div class="status success">âœ… ä¼šè¯çŠ¶æ€åŠ è½½æˆåŠŸ</div>
                    <div class="status info">å†å²æ¶ˆæ¯æ•°: ${historyCount}</div>
                    <div class="status info">æ‘˜è¦é•¿åº¦: ${summaryLength} å­—ç¬¦</div>
                    <div class="status info">æœ€åæ›´æ–°: ${new Date().toLocaleString()}</div>
                `;
                
                // å°†ä¼šè¯æ•°æ®å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼Œä¾›å½’æ¡£ä½¿ç”¨
                window.currentSession = data;
                
            } catch (error) {
                sessionDiv.innerHTML = `<div class="status error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function triggerDailyArchive() {
            const resultDiv = document.getElementById('archive-result');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨è§¦å‘æ¯æ—¥å½’æ¡£...</div>';
            
            try {
                // å¦‚æœæ²¡æœ‰åŠ è½½ä¼šè¯æ•°æ®ï¼Œå…ˆåŠ è½½
                if (!window.currentSession) {
                    const sessionResponse = await fetch('/session/load');
                    window.currentSession = await sessionResponse.json();
                }
                
                const archiveResponse = await fetch('/archive/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: window.currentSession.history || [],
                        summary: window.currentSession.summary || ''
                    })
                });
                
                const result = await archiveResponse.json();
                
                if (archiveResponse.ok) {
                    let statusHtml = '<div class="status success">âœ… æ¯æ—¥å½’æ¡£æ‰§è¡ŒæˆåŠŸ</div>';
                    
                    if (result.success) {
                        statusHtml += `<div class="status info">ğŸ“ ä¼šè¯æ‘˜è¦: ${(result.session_summary || '').substring(0, 100)}...</div>`;
                        statusHtml += `<div class="status info">ğŸ§  æ–°M2é•¿åº¦: ${(result.new_m2 || '').length} å­—ç¬¦</div>`;
                        statusHtml += `<div class="status info">ğŸ“š å½’æ¡£æ–‡ä»¶: ${result.archive_file || 'æœªçŸ¥'}</div>`;
                        statusHtml += `<div class="status info">ğŸ”§ M3è¡¥ä¸æ•°é‡: ${(result.patch_results || []).length}</div>`;
                        statusHtml += `<div class="status info">ğŸ—‘ï¸ M1å·²æ¸…ç©º: ${result.m1_cleared ? 'æ˜¯' : 'å¦'}</div>`;
                        
                        if (result.patch_results && result.patch_results.length > 0) {
                            statusHtml += '<div class="status info">ğŸ“‹ M3æ›´æ–°è¯¦æƒ…:</div>';
                            result.patch_results.forEach(patch => {
                                const status = patch.success ? 'âœ…' : 'âŒ';
                                statusHtml += `<div class="status info">  ${status} ${patch.filename}</div>`;
                            });
                        }
                    }
                    
                    resultDiv.innerHTML = statusHtml;
                    
                    // å½’æ¡£æˆåŠŸåé‡æ–°åŠ è½½ä¼šè¯çŠ¶æ€
                    setTimeout(() => {
                        loadCurrentSession();
                    }, 1000);
                    
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">âŒ å½’æ¡£å¤±è´¥</div>
                        <div class="status error">é”™è¯¯: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ å½’æ¡£æ‰§è¡Œå¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadMemoryList() {
            const listDiv = document.getElementById('memory-list');
            listDiv.innerHTML = '<div class="status info">åŠ è½½è®°å¿†æ–‡ä»¶åˆ—è¡¨ä¸­...</div>';
            
            try {
                const response = await fetch('/memory/list');
                const data = await response.json();
                
                if (data.files && data.files.length > 0) {
                    let listHtml = '<div class="status success">âœ… è®°å¿†æ–‡ä»¶åˆ—è¡¨åŠ è½½æˆåŠŸ</div>';
                    listHtml += '<div class="status info">ç‚¹å‡»æ–‡ä»¶åæŸ¥çœ‹å†…å®¹:</div>';
                    
                    data.files.forEach(filename => {
                        listHtml += `<div class="status info">ğŸ“„ <span style="cursor: pointer; text-decoration: underline;" onclick="loadSingleMemory('${filename}')">${filename}</span></div>`;
                    });
                    
                    listDiv.innerHTML = listHtml;
                } else {
                    listDiv.innerHTML = '<div class="status error">âŒ æœªæ‰¾åˆ°è®°å¿†æ–‡ä»¶</div>';
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="status error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadSingleMemory(filename) {
            const viewerDiv = document.getElementById('memory-viewer');
            viewerDiv.innerHTML = `<div class="status info">æ­£åœ¨åŠ è½½ ${filename}...</div>`;
            
            try {
                const response = await fetch('/memory/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const content = data.content || '';
                    const lines = content.split('\n').length;
                    const chars = content.length;
                    
                    viewerDiv.innerHTML = `
                        <div class="memory-file">
                            <h3 onclick="toggleMemoryContent('${filename}')">${filename} (${lines} è¡Œ, ${chars} å­—ç¬¦)</h3>
                            <div class="memory-meta">ç‚¹å‡»æ ‡é¢˜å±•å¼€/æ”¶èµ·å†…å®¹</div>
                            <div id="content-${filename}" class="memory-content">${escapeHtml(content)}</div>
                        </div>
                    `;
                } else {
                    viewerDiv.innerHTML = `<div class="status error">âŒ è¯»å–å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                viewerDiv.innerHTML = `<div class="status error">âŒ è¯»å–å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadAllMemories() {
            const viewerDiv = document.getElementById('memory-viewer');
            viewerDiv.innerHTML = '<div class="status info">æ­£åœ¨åŠ è½½æ‰€æœ‰è®°å¿†æ–‡ä»¶...</div>';
            
            try {
                // å…ˆè·å–æ–‡ä»¶åˆ—è¡¨
                const listResponse = await fetch('/memory/list');
                const listData = await listResponse.json();
                
                if (!listData.files || listData.files.length === 0) {
                    viewerDiv.innerHTML = '<div class="status error">âŒ æœªæ‰¾åˆ°è®°å¿†æ–‡ä»¶</div>';
                    return;
                }
                
                let allMemoriesHtml = '<div class="status success">âœ… æ‰€æœ‰è®°å¿†æ–‡ä»¶åŠ è½½å®Œæˆ</div>';
                
                // é€ä¸ªåŠ è½½æ¯ä¸ªæ–‡ä»¶
                for (const filename of listData.files) {
                    try {
                        const response = await fetch('/memory/read', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: filename })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            const content = data.content || '';
                            const lines = content.split('\n').length;
                            const chars = content.length;
                            
                            allMemoriesHtml += `
                                <div class="memory-file">
                                    <h3 onclick="toggleMemoryContent('${filename}')">${filename} (${lines} è¡Œ, ${chars} å­—ç¬¦)</h3>
                                    <div class="memory-meta">ç‚¹å‡»æ ‡é¢˜å±•å¼€/æ”¶èµ·å†…å®¹</div>
                                    <div id="content-${filename}" class="memory-content">${escapeHtml(content)}</div>
                                </div>
                            `;
                        } else {
                            allMemoriesHtml += `
                                <div class="memory-file">
                                    <h3>${filename}</h3>
                                    <div class="status error">è¯»å–å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        allMemoriesHtml += `
                            <div class="memory-file">
                                <h3>${filename}</h3>
                                <div class="status error">è¯»å–å¤±è´¥: ${error.message}</div>
                            </div>
                        `;
                    }
                }
                
                viewerDiv.innerHTML = allMemoriesHtml;
                
            } catch (error) {
                viewerDiv.innerHTML = `<div class="status error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function toggleMemoryContent(filename) {
            const contentDiv = document.getElementById(`content-${filename}`);
            if (contentDiv) {
                contentDiv.classList.toggle('expanded');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function deleteMemoryFile() {
            // å…ˆè·å–æ–‡ä»¶åˆ—è¡¨
            try {
                const listResponse = await fetch('/memory/list');
                const listData = await listResponse.json();
                
                if (!listData.files || listData.files.length === 0) {
                    alert('æ²¡æœ‰å¯åˆ é™¤çš„è®°å¿†æ–‡ä»¶');
                    return;
                }
                
                // è®©ç”¨æˆ·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶
                const filename = prompt(`è¯·è¾“å…¥è¦åˆ é™¤çš„æ–‡ä»¶åï¼š\n\nå¯ç”¨æ–‡ä»¶ï¼š\n${listData.files.join('\n')}`);
                
                if (!filename) return;
                
                if (!listData.files.includes(filename)) {
                    alert('æ–‡ä»¶ä¸å­˜åœ¨');
                    return;
                }
                
                if (!confirm(`ç¡®å®šè¦åˆ é™¤è®°å¿†æ–‡ä»¶ "${filename}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                    return;
                }
                
                // æ‰§è¡Œåˆ é™¤
                const deleteResponse = await fetch('/memory/delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });
                
                const deleteResult = await deleteResponse.json();
                
                if (deleteResult.success) {
                    alert(`æ–‡ä»¶ "${filename}" å·²æˆåŠŸåˆ é™¤`);
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadMemoryList();
                    // æ¸…ç©ºæŸ¥çœ‹å™¨
                    document.getElementById('memory-viewer').innerHTML = '';
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${deleteResult.error}`);
                }
                
            } catch (error) {
                alert(`åˆ é™¤æ“ä½œå¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            checkSystemStatus();
            loadCurrentSession();
            loadMemoryList();
        };
    </script>
</body>
</html>